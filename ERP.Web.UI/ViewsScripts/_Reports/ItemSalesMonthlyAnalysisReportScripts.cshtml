@using ERP.Web.UI.Controllers.Warehouses
@using ERP.Authorization;
@{
    //string permissionsStr = TempData["Permissions"].ToString();
}
<script>
    const _mainController = "Reports"

    $(function () {
        $('#ItemSalesMonthlyAnalysisReport').addClass('active');
    });

    $('#IvItemsTypesConfigureId').select2(ReturnSelect2ObjectDefault(`${baseUrl}/IvItemsTypesConfigure/GetIvItemsTypesConfigureWithParentSelect2`));
    $('#IvItemId').select2(ReturnSelect2ObjectDefault(`${baseUrl}/IvItems/GetSelect2`));
    $('#Year').select2(ReturnSelect2ObjectDefault(`${baseUrl}/GlPeriodsYears/GetGlPeriodsYearsReportSelect2`));
  
  
    const _loadDataUrl = `${$PrefixHostName}/${_mainController}/@nameof(ERP.Web.UI.Controllers.Reports.ReportsController.ItemSalesMonthlyAnalysisSearch)`;
    const _tblSelector = $('#tblDetails');


    const ReturnSelect2Year = function () {
        $.ajax({
            url: `${baseUrl}/GlPeriodsYears/GetGlPeriodsYearsReportSelect2`,
            cache: false,
            type: "GET",
            headers: {
                'Authorization': `Bearer ${$_token}`
            },
            data: {
                //  type: type,
                pageSize: 10,
                pageNumber: 1,
                searchTerm: "",
                lang: lang,
            },
            //data: function () {
            //        return {
            //          //  type: type,
            //            pageSize: 10,
            //            pageNumber: 1,
            //            searchTerm: "",
            //            lang: lang,
            //        };
            //    },
        })
            .done(function (data) {
              $(`#Year`).append($("<option selected='selected'></option>").val(data.result.results[0].id).text(data.result.results[0].text)).trigger('change');

            })
            .fail(function () {
                console.log("error");
            })
        //return {
        //    ajax: {
        //        url: `${baseUrl}/GlPeriodsYears/GetGlPeriodsYearsReportSelect2`,
        //        dataType: 'json',
        //        headers: {
        //            'Authorization': `Bearer ${$_token}`
        //        },
        //        data: function (params) {
        //            return {
        //              //  type: type,
        //                pageSize: 10,
        //                pageNumber: 1,
        //                searchTerm: "",
        //                lang: lang,
        //            };
        //        },
        //        processResults: function (data, params) {

        //            //var newOption = new Option(data.result.results[0].text, data.result.results[0].id, false, false);
        //            //$('#Year').append(newOption).trigger('change');
        //            $(`#Year`).append($("<option selected='selected'></option>").val(data.result.results[0].id).text(data.result.results[0].text)).trigger('change');
                   
        //        }
        //    },
        //    placeholder: select2Placeholder,
        //    minimumInputLength: 0,
        //    allowClear: true,
        //    language: select2Lang
        //};

    };
    $(function () {
    ReturnSelect2Year();

    })
    
    var OnBegin = function (response) {
        fireBtnLoader();
    };

    var OnSuccess = function (response) {

        if (response.success) {

            if (response.customRestResult.trigger === '@ERP.Front.Helpers.Enums.Common.FormTriggers.Insert') {

                toastr.success(response.customRestResult.message);

                LoadDataGrid();

                _mainModal.modal('hide');

            } else if (response.customRestResult.trigger === '@ERP.Front.Helpers.Enums.Common.FormTriggers.Update') {

                LoadDataGrid();

                _mainModal.modal('hide');

                toastr.success(response.customRestResult.message);
            }

        } else {
               toastr.error(response.customRestResult.message);
        }
    };

    var OnComplete = function (response) {
        downBtnLoader();
    };

    var OnFailure = function (response) {
        toastr.error(response);
        downBtnLoader();
    };

    const LoadDataGrid = function () {

        const parms = {

            TrItemId: $('#IvItemId').val(),
            IvItemsTypesConfigureId: $('#IvItemsTypesConfigureId').val(),
            Year: $('#Year').val(),
        };

        const columns = [

            {
                "data": "ItemNumber",
                "name": "ItemNumber",
                "autoWidth": true
            },
            {
                "data": "ItemName",
                "name": "ItemName",
                "autoWidth": true
            },
            {
                "data": "JanuarySale",
                "name": "JanuarySale",
                "autoWidth": true
            },
            //{
            //    "data": null,
            //    "autoWidth": true,
            //    "render": function (d, t, row) {

            //        return row.JanuaryValue ? parseFloat(row.JanuaryValue).toFixed(2) : 0;
            //    }
            //},
            {
                'data': 'JanuaryValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            },
             
            {
                "data": "FebruarySale",
                "name": "FebruarySale",
                "autoWidth": true
            },
            //{
            //    "data": null,
            //    "autoWidth": true,
            //    "render": function (d, t, row) {

            //        return row.FebruaryValue ? parseFloat(row.FebruaryValue).toFixed(2) : 0;
            //    }
            //},
            {
                'data': 'FebruaryValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            },
            {
                "data": "MarchSale",
                "name": "MarchSale",
                "autoWidth": true
            },
            //{
            //    "data": null,
            //    "autoWidth": true,
            //    "render": function (d, t, row) {

            //        return row.MarchValue? parseFloat(row.MarchValue).toFixed(2) : 0;
            //    }
            //},
            {
                'data': 'MarchValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            },
            {
                "data": "AprilSale",
                "name": "AprilSale",
                "autoWidth": true
            },
            {
                'data': 'AprilValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            },
            
            {
                "data": "MaySale",
                "name": "MaySale",
                "autoWidth": true
            },
            {
                'data': 'MayValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            },
            
            {
                "data": "JunSale",
                "name": "JunSale",
                "autoWidth": true
            },
            {
                'data': 'JunValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            },

           
             
           
            {
                "data": "JulSale",
                "name": "JulSale",
                "autoWidth": true
            },
            {
                'data': 'JulValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            },

             
             
            {
                "data": "AugustSale",
                "name": "AugustSale",
                "autoWidth": true
            },
            {
                'data': 'AugustValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            },
             
            
            {
                "data": "SeptemberSale",
                "name": "SeptemberSale",
                "autoWidth": true
            },
            {
                'data': 'SeptemberValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            },
             
            
            {
                "data": "OctoberSale",
                "name": "OctoberSale",
                "autoWidth": true
            },
            {
                'data': 'OctoberValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            },

            
            
            {
                "data": "NovemberSale",
                "name": "NovemberSale",
                "autoWidth": true
            },
            {
                'data': 'NovemberValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            },
            
             
            {
                "data": "DecemberSale",
                "name": "DecemberSale",
                "autoWidth": true
            },
            {
                'data': 'DecemberValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            },
            {
                'data': 'TotalValue',
                "render": $.fn.dataTable.render.number(',', '.', 2),
            }
             

        ];

        const dtObj = {

            "footerCallback": function (row, data, start, end, display) {
                var api = this.api(), data;

                // converting to interger to find total
                var intVal = function (i) {
                    return typeof i === 'string' ?
                        i.replace(/[\$,]/g, '') * 1 :
                        typeof i === 'number' ?
                            i : 0;
                };

                // computing column Total of the complete result 
                var janTotal = data[0]?.JanTotal;
                    //api
                    //.column(3)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);

                
               
               

                var fabTotal = data[0]?.FebTotal;
                    //api
                    //.column(5)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);
                console.log(fabTotal);
                var marTotal = data[0]?.MarchTotal;
                    //api
                    //.column(7)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);

                var aprilTotal = data[0]?.AprilTotal;
                    //api
                    //.column(9)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);
                var mayTotal = data[0]?.MayTotal;
                    //api
                    //.column(11)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);
                var junTotal = data[0]?.JunTotal;
                    //api
                    //.column(13)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);
                var julyTotal = data[0]?.JulyTotal;
                    //api
                    //.column(15)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);
                var augustTotal = data[0]?.AugTotal;
                    //api
                    //.column(17)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);
                var sepTotal = data[0]?.SepTotal;
                    //api
                    //.column(19)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);
                var octTotal = data[0]?.OctTotal;
                    //api
                    //.column(21)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);
                var novTotal = data[0]?.NovTotal;
                    //api
                    //.column(23)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);
                var decTotal = data[0]?.DecTotal;
                    //api
                    //.column(25)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);
                var Totalamount = data[0]?.GrandTotal;
                    //api
                    //.column(26)
                    //.data()
                    //.reduce(function (a, b) {
                    //    return intVal(a) + intVal(b);
                    //}, 0);

                // Update footer by showing the total with the reference of the column index 
                $(api.column(2).footer()).html('Total :');
                $(api.column(3).footer()).html(janTotal?.toFixed(2));
              //  $(api.column(4).footer()).html('Total :');
                $(api.column(5).footer()).html(fabTotal?.toFixed(2));
              //  $(api.column(6).footer()).html('Total :');
                $(api.column(7).footer()).html(marTotal?.toFixed(2));
              //  $(api.column(8).footer()).html('Total :');
                $(api.column(9).footer()).html(aprilTotal?.toFixed(2));
            //    $(api.column(10).footer()).html('Total :');
                $(api.column(11).footer()).html(mayTotal?.toFixed(2));
              //  $(api.column(12).footer()).html('Total :');
                $(api.column(13).footer()).html(junTotal?.toFixed(2));
              // $(api.column(14).footer()).html('Total :');
                $(api.column(15).footer()).html(julyTotal?.toFixed(2));
              //  $(api.column(16).footer()).html('Total :');
                $(api.column(17).footer()).html(augustTotal?.toFixed(2));
              //  $(api.column(18).footer()).html('Total :');
                $(api.column(19).footer()).html(sepTotal?.toFixed(2));
             //   $(api.column(20).footer()).html('Total :');
                $(api.column(21).footer()).html(octTotal?.toFixed(2));
              //  $(api.column(22).footer()).html('Total :');
                $(api.column(23).footer()).html(novTotal?.toFixed(2));
               // $(api.column(24).footer()).html('Total :');
                $(api.column(25).footer()).html(decTotal?.toFixed(2));
                $(api.column(26).footer()).html(Totalamount?.toFixed(2));
            },

            'columnDefs': [
                { className: 'text-center', targets: [0,2,4,6,8,10,12,14,16,18,20,22,24] },
                { className: 'text-right', targets:  [3,5,7,9,11,13,15,17,19,21,23,25] },
                //{
                //    "targets": 0, // your case first column
                //    "className": "text-center",
                //    "width": "4%"
                //},
                //{
                //    "targets": 2,
                //    "className": "text-right",
                //}
            ],

            "processing": true,
            "serverSide": true,
            "filter": false,
            "orderMulti": false,
            "language": dataTableLang,
            "ajax": {
                "url": _loadDataUrl,
                "type": "POST",
                "datatype": "json",
                "data": parms,
                "complete": function () { }
            },
            "columns": columns,
            "initComplete": function () {
                $('[data-toggle="tooltip"]').tooltip();
            }

        };

        _tblSelector.dataTable().fnDestroy();
        _tblSelector.DataTable(dtObj).on('draw', function () { $('[data-toggle="tooltip"]').tooltip(); });


    };

    

    //$('#IvItemsTypesConfigureIdSearch').select2(ReturnSelect2ObjectDefault(`${baseUrl}/IvItemsTypesConfigure/GetIvItemsTypesConfigureWithParentSelect2`));
    //$('#IvUnitIdSearch').select2(ReturnSelect2ObjectDefault(`${baseUrl}/IvUnits/GetIvUnitsSelect2`));



    function printExc() {
        $('.page-loader-wrapper').show();
        //$('#tblDetails').parent().addClass('d-none');
        
        const parmss = {

            TrItemId: $('#IvItemId').val(),
            IvItemsTypesConfigureId: $('#IvItemsTypesConfigureId').val(),
            Year: $('#Year').val(),
            length: 1000000
        };
        const columns = [

            {
                "data": "ItemNumber",
                "name": "ItemNumber",
                "autoWidth": true
            },
            {
                "data": "ItemName",
                "name": "ItemName",
                "autoWidth": true
            },
            {
                "data": "JanuarySale",
                "name": "JanuarySale",
                "autoWidth": true
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.JanuaryValue ? parseFloat(row.JanuaryValue).toFixed(2) : '';
                }
            },

            {
                "data": "FebruarySale",
                "name": "FebruarySale",
                "autoWidth": true
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.FebruaryValue ? parseFloat(row.FebruaryValue).toFixed(2) : '';
                }
            },

            {
                "data": "MarchSale",
                "name": "MarchSale",
                "autoWidth": true
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.MarchValue ? parseFloat(row.MarchValue).toFixed(2) : '';
                }
            },
            {
                "data": "AprilSale",
                "name": "AprilSale",
                "autoWidth": true
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.AprilValue ? parseFloat(row.AprilValue).toFixed(2) : '';
                }
            },

            {
                "data": "MaySale",
                "name": "MaySale",
                "autoWidth": true
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.MayValue ? parseFloat(row.MayValue).toFixed(2) : '';
                }
            },
            {
                "data": "JunSale",
                "name": "JunSale",
                "autoWidth": true
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.JunValue ? parseFloat(row.JunValue).toFixed(2) : '';
                }
            },


            {
                "data": "JulSale",
                "name": "JulSale",
                "autoWidth": true
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.JulValue ? parseFloat(row.JulValue).toFixed(2) : '';
                }
            },

            {
                "data": "AugustSale",
                "name": "AugustSale",
                "autoWidth": true
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.AugustValue ? parseFloat(row.AugustValue).toFixed(2) : '';
                }
            },

            {
                "data": "SeptemberSale",
                "name": "SeptemberSale",
                "autoWidth": true
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.SeptemberValue ? parseFloat(row.SeptemberValue).toFixed(2) : '';
                }
            },

            {
                "data": "OctoberSale",
                "name": "OctoberSale",
                "autoWidth": true
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.OctoberValue ? parseFloat(row.OctoberValue).toFixed(2) : '';
                }
            },

            {
                "data": "NovemberSale",
                "name": "NovemberSale",
                "autoWidth": true
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.NovemberValue ? parseFloat(row.NovemberValue).toFixed(2) : '';
                }
            },

            {
                "data": "DecemberSale",
                "name": "DecemberSale",
                "autoWidth": true
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.DecemberValue ? parseFloat(row.DecemberValue).toFixed(2) : '';
                }
            },
            {
                "data": null,
                "autoWidth": true,
                "render": function (d, t, row) {

                    return row.TotalValue ? parseFloat(row.TotalValue).toFixed(2) : '';
                }
            }

        ];



        const dtObj1 = {
            "footerCallback": function (row, data, start, end, display) {
                var api = this.api(), data;

                // converting to interger to find total
                var intVal = function (i) {
                    return typeof i === 'string' ?
                        i.replace(/[\$,]/g, '') * 1 :
                        typeof i === 'number' ?
                            i : 0;
                };

                // computing column Total of the complete result 
                var janTotal = data[0]?.JanTotal;
                //api
                //.column(3)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);





                var fabTotal = data[0]?.FebTotal;
                //api
                //.column(5)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);
                console.log(fabTotal);
                var marTotal = data[0]?.MarchTotal;
                //api
                //.column(7)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);

                var aprilTotal = data[0]?.AprilTotal;
                //api
                //.column(9)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);
                var mayTotal = data[0]?.MayTotal;
                //api
                //.column(11)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);
                var junTotal = data[0]?.JunTotal;
                //api
                //.column(13)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);
                var julyTotal = data[0]?.JulyTotal;
                //api
                //.column(15)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);
                var augustTotal = data[0]?.AugTotal;
                //api
                //.column(17)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);
                var sepTotal = data[0]?.SepTotal;
                //api
                //.column(19)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);
                var octTotal = data[0]?.OctTotal;
                //api
                //.column(21)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);
                var novTotal = data[0]?.NovTotal;
                //api
                //.column(23)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);
                var decTotal = data[0]?.DecTotal;
                //api
                //.column(25)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);
                var Totalamount = data[0]?.GrandTotal;
                //api
                //.column(26)
                //.data()
                //.reduce(function (a, b) {
                //    return intVal(a) + intVal(b);
                //}, 0);

                // Update footer by showing the total with the reference of the column index 
                $(api.column(2).footer()).html('Total :');
                $(api.column(3).footer()).html(janTotal?.toFixed(2));
                //  $(api.column(4).footer()).html('Total :');
                $(api.column(5).footer()).html(fabTotal?.toFixed(2));
                //  $(api.column(6).footer()).html('Total :');
                $(api.column(7).footer()).html(marTotal?.toFixed(2));
                //  $(api.column(8).footer()).html('Total :');
                $(api.column(9).footer()).html(aprilTotal?.toFixed(2));
                //    $(api.column(10).footer()).html('Total :');
                $(api.column(11).footer()).html(mayTotal?.toFixed(2));
                //  $(api.column(12).footer()).html('Total :');
                $(api.column(13).footer()).html(junTotal?.toFixed(2));
                // $(api.column(14).footer()).html('Total :');
                $(api.column(15).footer()).html(julyTotal?.toFixed(2));
                //  $(api.column(16).footer()).html('Total :');
                $(api.column(17).footer()).html(augustTotal?.toFixed(2));
                //  $(api.column(18).footer()).html('Total :');
                $(api.column(19).footer()).html(sepTotal?.toFixed(2));
                //   $(api.column(20).footer()).html('Total :');
                $(api.column(21).footer()).html(octTotal?.toFixed(2));
                //  $(api.column(22).footer()).html('Total :');
                $(api.column(23).footer()).html(novTotal?.toFixed(2));
                // $(api.column(24).footer()).html('Total :');
                $(api.column(25).footer()).html(decTotal?.toFixed(2));
                $(api.column(26).footer()).html(Totalamount?.toFixed(2));
            },
            "language": dataTableLang,
            "dom": 'Bfrtip',
            "buttons": [
                {
                    extend: 'excel',
                    footer: true,
                  
                },

            ],
            "ajax": {
                "url": _loadDataUrl,
                "type": "POST",
                "datatype": "json",
                "data": parmss,
                "complete": function (d) {
                    $('.page-loader-wrapper').hide()
                }
            },
            "columns": columns,

            "initComplete": function () {
                //$('#tblDetailsPrint button.dt-button').click();
                $('button.buttons-excel').hide();
                $('button.buttons-excel').click();
                $('#tblDetailsPrint').parent().addClass('d-none');

            }
        };

       

        $('#tblDetailsPrint').dataTable().fnDestroy();
        $('#tblDetailsPrint').DataTable(dtObj1).on('buttons-processing', function (e, indicator) { if (!indicator) { $('.page-loader-wrapper').hide() } });


    }

</script>

