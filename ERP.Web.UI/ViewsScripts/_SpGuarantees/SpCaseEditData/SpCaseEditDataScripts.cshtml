@using ERP.ResourcePack.SpGuarantees
@using ERP.Authorization;
@{
    string permissionsStr = TempData["Permissions"].ToString();
    string encUpdateTrigger = ERP.Front.Helpers.Enums.Common.EncUpdate;
}
<script>

    const _booBoxMessageUpdateOneCase = '@SpCaseEditData.AreYouSureEditOneCase';
    const _booBoxMessageUpdateAllCases = '@SpCaseEditData.AreYouSureEditAllCases';

    $('#searchBox #BeneficentId').select2(ReturnSelect2ObjectDefault(`${baseUrl}/SpBeneficent/GetSpBeneficentSelect2`));
    $('#searchBox #CaseId').select2(ReturnSelect2ObjectDefault(`${baseUrl}/SpCases/GetSpCasesGrantedSelect2`));
    //$('#BankLkpId').select2(ReturnSelect2ObjectDefault(`${baseUrl}/SpBeneficent/GetSpBeneficentBanksSelect2`));

    //$('#BankLkpId').select2(ReturnSelect2ObjectForLkpsTypes('@ERP.Front.Helpers.Enums.Common.FndLkpsTypes.Banks.ToString()'));

    $('#SpCaseEditData').addClass('active');

    setTimeout(function () {
            $('#SpCaseEditData').children('a').removeClass('toggled');
    }, 100);

    const _permissions = '@permissionsStr';
    @*const _postPerm = '@PermissionNames.Pages_SpCaseEditData_Post';*@
    const _contactDetails = [];

    const LoadDataGrid = function () {

        if (!validator()) return;

        $.ajax({
            url: `${baseUrl}/SpCaseEditData/GetSpCasesContractDetails`,
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${$_token}`
            },
            data: {
                CaseId: $('#CaseId').find(':selected').val(),
                BeneficentId: $('#BeneficentId').find(':selected').val(),
                BeneficentNumber: $('#BeneficentNumber').val(),
                CaseNumber: $('#CaseNumber').val()
            }
        }).done(function (data) {

            if (data.result) {
                bindDataTable(data.result);
            }

        });
    };

    const bindDataTable = function (data) {


        const columns = [
            {
                "data": "result.data.id",
                'render': function (data, type, row, meta) {
                    return meta.row + meta.settings._iDisplayStart + 1;
                }
            },
            { 'data': 'contractNumber' },
            { 'data': 'startDate' },
            { 'data': 'beneficentNumber' },
            { 'data': 'beneficentName' },
            { 'data': 'caseNumber' },
            { 'data': 'caseName' },
            { 'data': lang=="ar-EG" ? 'beneficentBankAr' : 'beneficentBankEn' },
            { 'data': 'accountOwner' },
            { 'data': 'accountNumber' },
            { 'data': 'nameFor' },
            { 'data': 'amount' },
            //{ 'data': 'operationDate' },
            {
                'data': null,
                'searchable': false,
                'ordering': false,
                'sorting': false,
                'render': function (d, t, row) {
                    let btns = `<a href="${$PrefixHostName}/SpCaseEditData/FormView?id=${row.encId}&t=@encUpdateTrigger" title="@ERP.ResourcePack.Common.Settings.Edit"><i class="mx-2 fas fa-edit text-info"></i></a>`;
                    return btns;
                }
            }
        ];

        const dtObj = {
            data: data,
            retrieve: true,
            language: dataTableLang,
            columns: columns,
            drawCallback: function (c, v, b) { }
        };

        $('#tblSpCaseEditData').dataTable().fnDestroy();
        $('#tblSpCaseEditData').DataTable(dtObj).on('draw', function () { $('[data-toggle="tooltip"]').tooltip(); });

    };

    const validator = function () {

        @*let valid = false;

        if ($('#BeneficentId').find(':selected').val()) valid = true;
        if ($('#CaseId').find(':selected').val()) valid = true;

        if (!$('#BeneficentId').find(':selected').val() && !valid) {
            toastr.warning(`@SpCaseEditData.BeneficentName : @ERP.ResourcePack.Common.Settings.Required`);
            return false;
        }
        else if (!$('#CaseId').find(':selected').val() && !valid) {
            toastr.warning(`@SpCaseEditData.CaseName : @ERP.ResourcePack.Common.Settings.Required`);
            return false;
        }*@

        return true;
    };

    //const SetData = function (e, contractDetailsId) {

    //    if (e.target.checked) {
    //        _contactDetails.push(contractDetailsId);
    //    } else {
    //        _contactDetails.splice(_contactDetails.indexOf(_contactDetails.find(z => z == contractDetailsId)), 1);
    //    }

    //};

    const OperateCase = function (operationType) {

        @*if (_contactDetails.length == 0) {
            toastr.warning(`@SpCaseEditData.MustCheckAtLeastOneCase`);
            return;
        }*@

        @*if (!$('#OperationDateStr').val()) {
            toastr.warning(`@SpCaseEditData.OperationDate : @ERP.ResourcePack.Common.Settings.Required`);
            return;
        }*@
        var urlForOperation = operationType == "One" ? "EditCase" : "EditAllCases";
        var ConfirmMessage = operationType == "One" ? _booBoxMessageUpdateOneCase : _booBoxMessageUpdateAllCases;
        bootbox.confirm({
            message: ConfirmMessage,
            buttons: bootBoxDefaultBtns,
            callback: function (result) {

                if (result) {

                    const data = {
                        ids: _contactDetails.toString(),
                        accountOwnerName: $('#AccountOwner').val(),
                        accountNumber: $('#AccountNumber').val(),
                        sponsFor: $('#NameFor').val(),
                        amount: $('#Amount').val(),
                        notes: $('#Notes').val(),
                        spContractDetailsId: $('#SpContractDetailsId').val(),
                        bankLkpId: $('#BankLkpId').find(':selected').val(),
                        lang: lang,
                        tenantId: 0,
                        userId: 0
                    };

                    $.ajax({
                        url: `${baseUrl}/SpCaseEditData/${urlForOperation}`,
                        type: 'POST',
                        data: JSON.stringify(data),
                        headers:
                        {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${$_token}`
                        },
                    }).done(function (response) {

                        if (response.result.finalStatues == 'F') {
                            toastr.warning(response.result.reason);
                        }
                        else {
                            clear();
                            toastr.success(response.result.reason);
                        }

                    }).fail(function (response) {
                        toastr.error(response.responseText);
                    });
                }
            }
        });
    };

    const clear = function () {

        $('input').val('');
        $('select').val('').trigger('change');
        $('#tblSpCaseEditData').dataTable().fnDestroy();

        setTimeout(function () {
            $('table tbody').empty();
        }, 50);
    };

</script>
