@using ERP.Web.UI.Controllers.Authentications
@using ERP.Web.UI.Models.ViewModels.Authentications

@model RoleUsersVM
@{
    string formTrigger = ViewBag.trigger;
    string lang = Request.Cookies["Lang"] == null ? "ar-EG" : Request.Cookies["Lang"].Value.ToString();
}
<div class="card">
    <div class="body">
        @using (Ajax.BeginForm(
            nameof(RolesController.PostUsersToRole), "Roles",
            new AjaxOptions { HttpMethod = "POST", OnBegin = "OnBegin", OnSuccess = "OnSuccess", OnComplete = "OnComplete", OnFailure = "OnFailure" }, new { @id = "mainForm" }))
        {
            @Html.HiddenFor(z => z.RoleId)
            <div class="row clearfix">
                <div class="col-sm-12">
                    <div class="form-group form-float">
                        <div class="form-line">
                            <label for="UsersInRole" class="col-md-12 control-label">@ERP.ResourcePack.Authentications.Roles.UsersForRole</label>
                            <select multiple class="form-control" id="UserIds" name="UserIds"></select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="body collapse show" id="dataCollapse">
                <div class="table-responsive">
                    <div id="tblLoader" style="display:none">
                        <div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                    </div>
                    <table class="table table-bordered table-striped table-hover js-basic-example dataTable" id="tblRoles">
                        <thead>
                            <tr>
                                <th><i class="fas fa-hashtag"></i></th>
                                <th>@ERP.ResourcePack.Authentications.Users.UserName</th>
                                <th><i class="fas fa-cogs"></i></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var userInRole in Model.UsersInRole)
                            {
                                <tr id="@userInRole.Id">
                                    <td></td>
                                    <td>@userInRole.Name</td>
                                    <td>
                                        <a href="javascript:void(0)" onclick="AjaxController.DeleteTableRowOnTheFly(@userInRole.Id, `${$PrefixHostName}/Roles/DeleteUserFromRole?RoleId=@Model.RoleId&UserId=@userInRole.Id` );"><i class="mx-2 fas fa-trash-alt text-danger"></i></a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>            
            </div>

            <div class="row clearfix">
                <div class="form-group text-center form-float">
                    <button type="submit" class="btn btn-info btn-lg m-l-15 waves-effect">@ERP.ResourcePack.Common.Settings.BtnSave</button>
                    <div id="submitLoader" style="display:none">
                        <div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                    </div>
                </div>
            </div>
        }

    </div>
</div>
<script src="~/Scripts/jquery.validate.min.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>
<script src="~/AssetsPack/assets/js/pages/forms/basic-form-elements.js"></script>
<script>

    var ddlUsers = $('#main-modal #UserIds');

    ddlUsers.select2({
        ajax: {
            url: `${baseUrl}/User/GetUsersSelect2`,
            dataType: 'json',
            headers: {
                'Authorization': `Bearer ${$_token}`
            },
            data: function (params) {
                params.page = params.page || 1;
                return {
                    searchTerm: params.term,
                    pageSize: pageSize,
                    pageNumber: params.page,
                    lang:lang
                };
            },
            processResults: function (data, params) {
                params.page = params.page || 1;
                return {
                    results: data.result.results,
                    pagination: {
                        more: (params.page * pageSize) < data.result.total
                    }
                };
            }
        },
        placeholder: select2Placeholder,
        minimumInputLength: 0,
        allowClear: true,
        multiple: true,
        maximumSelectionLength: 250,
        language: select2Lang

    });

    var mainForm = $('#main-modal #mainForm');

    mainForm.submit(function () {
        var x = ddlUsers.val();
        
        if (x) {
            console.log(x);
            return true; // return false to cancel form action
        } else {
            //toastr.warning(AddPhoto);
            return false;
        }
    });

</script>
