
@using ERP.ResourcePack.Accounts;
@using ERP.Web.UI.Models.ViewModels.Tenant;
@using ERP.ResourcePack.Common;
@model  TenantModuleVM
@{
    string lang = Request.Cookies["Lang"] == null ? "ar-EG" : Request.Cookies["Lang"].Value.ToString();
}

<style>
    .js-module-chk {
        position: fixed !important;
    }
</style>
<div class="card">
    <div class="body">
        <div class="row clearfix">
            <div class="row no-gutters clearfix  ">
                <div class="col-sm-12">
                    <div class="card shadow-rounded ">
                        <div class="card-body ">

                            <h3 class="card-title text-center">@Model.TenantInfo.Name</h3>
                            <input type="hidden" name="TenantId" id="TenantId" value="@Model.TenantInfo.Id" />
                            <div class="row clearfix">

                                <div class="col-sm-4">
                                    <div class="form-group form-float">
                                        <div class="form-line">
                                            <input disabled type="text" class="form-control" name="Tel" value="@Model.TenantInfo.Tel" />
                                            <label class="form-label">@ReportsAccounts.Tel</label>

                                        </div>
                                    </div>
                                </div>


                                <div class="col-sm-4">
                                    <div class="form-group form-float">
                                        <div class="form-line">
                                            <input disabled type="text" class="form-group" name="Email" value="@Model.TenantInfo.Email" />
                                            <label class="form-label">@ReportsAccounts.Email</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-4">
                                    <div class="form-group form-float">
                                        <div class="form-line">
                                            <input disabled type="text" class="form-group" name="CreationTime" value="@Model.TenantInfo.CreationTime" />
                                            <label class="form-label">@ReportsAccounts.CreationTime</label>
                                        </div>
                                    </div>
                                </div>


                                <div class="col-sm-4">
                                    <div class="form-group form-float">
                                        <div class="form-line">
                                            <input disabled type="text" class="form-group" name="ManagerName" value="@Model.TenantInfo.ManagerName" />
                                            <label class="form-label">@ReportsAccounts.ManagerName</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-sm-4">
                                    <div class="form-group form-float">
                                        <div class="form-line">
                                            <input disabled type="text" class="form-group" name="RemainingDays" value="@Model.TenantInfo.RemainingDays" />
                                            <label class="form-label">@ReportsAccounts.RemainingDays</label>
                                        </div>
                                    </div>
                                </div>




                            </div>

                        </div>
                    </div>

                    <div class="card shadow-rounded">
                        <div class="table-responsive">
                            <div id="tblLoader" style="display:none">
                                <div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                            </div>
                            <table class="table table-bordered table-striped table-hover js-basic-example dataTable" id="tblRoles">
                                <thead>
                                    <tr>
                                        <th>@Pages.ModuleNameAr</th>
                                        <th>@Pages.ModuleNameEn</th>
                                        <th><i class="fas fa-cogs"></i></th>
                                    </tr>
                                </thead>
                                <tbody>

                                    @foreach (var Module in Model.TenantModules)
                                    {
                                        <tr class="modulePage" id="@Module.Selector">
                                            <td class="selectAll">
                                                <label for="@Module.ModuleId" class="">@Module.NameAr</label>
                                            </td>
                                            <td class="selectAll">
                                                <label for="@Module.ModuleId">@Module.NameEn</label>
                                            </td>
                                            <td class="">
                                                <input @(Module.IsFree ? "checked" : "") id="@Module.ModuleId" data-tenent-id="@Module.TenantId" class="js-module-chk" data-last-status="@(Module.IsFree? "True" : "False")" type="checkbox" style="opacity:10; pointer-events:visible;">
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row clearfix">
            <div class="form-group text-center form-float">
                <button id="freeModulesSaveBtn" type="button" class="btn btn-primary btn-lg m-l-15 waves-effect">@ERP.ResourcePack.Common.Settings.BtnSave</button>
                <div id="submitLoader" style="display:none">
                    <div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="~/Scripts/jquery.validate.min.js"></script>
<script src="~/Scripts/jquery.validate.unobtrusive.min.js"></script>
<script src="~/AssetsPack/assets/js/pages/forms/basic-form-elements.js"></script>

<script>
    let _freeModulesArr = [];
    $('.js-module-chk').change(function () {
        let lastStatus = $(this).data('last-status');
        let TenentId = $(this).data('tenent-id');
        let ModuleId = $(this).attr('id')
        var obj = {
            lastStatus: lastStatus,
            TenentId: TenentId,
            ModuleId: ModuleId
        }
        const current = _freeModulesArr.find(z => z.TenentId === TenentId && z.ModuleId === ModuleId);
        let indexOfCurrent = _freeModulesArr.indexOf(current);
        if (this.checked) {
            if (lastStatus === 'False') {
                obj.Status = 'NEW';
                _freeModulesArr.push(obj)
            } else {
                obj.Status = 'NoChanged';
                _freeModulesArr.splice(indexOfCurrent, 1, obj);
            }
        } else {
            if (lastStatus === 'True') {
                obj.Status = 'Delete';
                if (current) {
                    _freeModulesArr.splice(indexOfCurrent, 1, obj);
                } else {
                    _freeModulesArr.push(obj);
                }
            } else {
                _freeModulesArr.splice(indexOfCurrent, 1);
            }
        }
    });

    $('#freeModulesSaveBtn').click(function () {
        //debugger;
            $.ajax({
                url: `${baseUrl}/TenantFreeModules/PostFreeModules`,
                cache: false,
                type: "POST",
                headers: {
                    'Authorization': `Bearer ${$_token}`,
                    'Content-Type': 'application/json',
                },
                data: JSON.stringify(_freeModulesArr)
            })
                .done(function (data) {
                    if (data.result === true) {
                        toastr.success('@ERP.ResourcePack.Accounts.ReportsAccounts.Sved')

                        setTimeout(function () {
                            location.reload()
                         }, 1000);
                    }
                })
                .fail(function () {
                    toastr.error('@ERP.ResourcePack.Accounts.ReportsAccounts.Faild')
                    setTimeout(function () {
                        location.reload()
                    }, 1000);
                })
    });

    $('#main-modal').on('hidden.bs.modal', function () {
        setTimeout(function () {
            location.reload()
        }, 100);
    })
</script>